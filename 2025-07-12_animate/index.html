<!DOCTYPE html>
<html>

<head>
  <!-- 3Dmol.js stuff -->
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <script>
    function init() {
      // console.log("init() started")
      viewer = $3Dmol.viewers[0]
      $3Dmol.get('traj.xyz', function (data) {
        viewer.addModelsAsFrames(data, "xyz");
        viewer.setStyle({ stick: { showNonBonded: true } });
        viewer.zoomTo();
        viewer.render();
      });
      //   console.log("init() finished")
    }
    
    function sleep(ms) {
      // See https://stackoverflow.com/a/39914235
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    async function animate_frames(trajid) {
      source = await setup_plot();
      let {states, sources, n_steps} = await setup_e_plot(trajid);

      viewer = $3Dmol.viewers[0];
      for (i = 0; i < n_steps; i++) {
        document.getElementById("fnum").innerHTML = i;
        await viewer.setFrame(i);
        viewer.render();
        source.selected.indices = [i];
        sources[states[i]-1].selected.indices = [i];
        await sleep(1);
        /*
        if (states[i] == 1) {
          source1.selected.indices = [i];
        } else if (states[i] == 2) {
          source2.selected.indices = [i];
        } else if (states[i] == 3) {
          source3.selected.indices = [i];
        }
        await sleep(1);
        */
      }
      
    }
  </script>
  
  <!-- BokehJS stuff -->
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.7.3.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-gl-3.7.3.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.7.3.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.7.3.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-3.7.3.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-api-3.7.3.min.js"></script>
  <script>
    async function setup_plot() {
      data = await fetch("data.json")
        .then(resp => resp.json())
      const source = new Bokeh.ColumnDataSource({ data: data });
      const plot = Bokeh.Plotting.figure({});
      plot.scatter(
        { field: 'PC1' },
        { field: 'PC2' },
        { source: source, selection_color: 'red' }
      );
      Bokeh.Plotting.show(plot);
      return source
    }
    
  </script>

  <script>
    async function setup_e_plot(trajid) {
      data = await fetch("butene.json")
        .then(resp => resp.json())
      console.log(data);
      const n_states = Number(data.attrs.num_singlets) + Number(data.attrs.num_doublets) + Number(data.attrs.num_triplets);
      const energy = data.data_vars.energy.data;
      const first = data.coords.trajid.data.indexOf(trajid);
      const last = data.coords.trajid.data.lastIndexOf(trajid);
      const n_steps = last - first;
      const time = data.coords.time.data.slice(first, last)
      const states = data.data_vars.astate.data.slice(first, last);

      const sources = Array(n_states);
      const plot = Bokeh.Plotting.figure({});
      for (i = 0; i < n_states; i++) {
        //console.log(energy[i]); 
        sources[i] = new Bokeh.ColumnDataSource({ data: {x: time, y: energy[i].slice(first, last)} });
        plot.scatter(
          { field: 'x' },
          { field: 'y' },
          { source: sources[i], selection_color: 'red' }
        );
        Bokeh.Plotting.show(plot);
      }

      return {states, sources, n_steps}
      /*
      const source1 = new Bokeh.ColumnDataSource({ data: {x: time.slice(0, 300), y: energy[0]} });
      const plot = Bokeh.Plotting.figure({});
      plot.scatter(
        { field: 'x' },
        { field: 'y' },
        { source: source1, selection_color: 'red' }
      );
      const source2 = new Bokeh.ColumnDataSource({ data: {x: time.slice(0, 300), y: energy[1]} });
      plot.scatter(
        { field: 'x' },
        { field: 'y' },
        { source: source2, selection_color: 'red' }
      );
      const source3 = new Bokeh.ColumnDataSource({ data: {x: time.slice(0, 300), y: energy[2]} });
      plot.scatter(
        { field: 'x' },
        { field: 'y' },
        { source: source3, selection_color: 'red' }
      );
      Bokeh.Plotting.show(plot);
      return {states, source1, source2, source3}
    */
    }
    
  </script>
</head>

<body onload="init()" id="page-top" class="index">
  <div class="col-lg-6 text-center">
    <div style="position:relative;
    height: 415px;
    width: 540px;" class='viewer_3Dmoljs' data-backgroundcolor='0xffffff' data-style='stick'
    data-ui='true'>
  </div>
  <p id="fnum">Frame number</p>
  <button onclick="animate_frames(3)">Start Animation</button>
</div>
</body>

</html>